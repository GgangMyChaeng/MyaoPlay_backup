<!-- templates/popup.html -->
<div class="autobgm-modal abgm-surface">
  <div class="autobgm-modal-h">
    <div id="abgm_modal_enabled_btn" class="menu_button abgm-extmenu-tile abgm-modal-power-btn" title="Enabled">
      <img id="abgm_modal_enabled_img" class="abgm-extbtn-icon" alt="Enabled" />
    </div>

    <div class="modal-header-buttons">
      <div class="abgm-iconbtn" id="abgm_modal_back" title="Back to Menu">
        <i class="fa-solid fa-arrow-left fa-lg"></i>
      </div>
      <div class="abgm-iconbtn" id="abgm_modal_close" title="Close">
        <i class="fa-solid fa-xmark fa-lg"></i>
      </div>
    </div>
  </div>

  <!-- Tab Bar -->
<div class="myaoplay-tabbar" role="tablist" aria-label="Settings tabs">
  <button class="myaoplay-tab-btn is-active" role="tab" aria-selected="true" aria-controls="myaoplay-panel-main" id="myaoplay-tab-main" tabindex="0" data-tab="main">
    🎵 메인
  </button>
  <button class="myaoplay-tab-btn" role="tab" aria-selected="false" aria-controls="myaoplay-panel-mode" id="myaoplay-tab-mode" tabindex="-1" data-tab="mode">
    ⚙️ 모드
  </button>
  <button class="myaoplay-tab-btn" role="tab" aria-selected="false" aria-controls="myaoplay-panel-sources" id="myaoplay-tab-sources" tabindex="-1" data-tab="sources">
    📁 소스
  </button>
  <button class="myaoplay-tab-btn" role="tab" aria-selected="false" aria-controls="myaoplay-panel-theme" id="myaoplay-tab-theme" tabindex="-1" data-tab="theme">
    🎨 테마
  </button>
  <button class="myaoplay-tab-btn" role="tab" aria-selected="false" aria-controls="myaoplay-panel-about" id="myaoplay-tab-about" tabindex="-1" data-tab="about">
    ℹ️ 정보
  </button>
</div>

  <!-- Main Panel (기존 콘텐츠) -->
<div class="myaoplay-tab-panel is-active" role="tabpanel" id="myaoplay-panel-main" aria-labelledby="myaoplay-tab-main" tabindex="0">
  
  <!-- 상단 옵션 -->
<div class="abgm-top-controls">

<!-- Now Playing -->
<div class="abgm-nowplaying"
  style="display:flex; gap:10px; align-items:baseline; flex-wrap:wrap;
         padding:8px 10px; border:1px solid rgba(255,255,255,.12);
         border-radius:12px; background:rgba(0,0,0,.18); margin:10px 0;">
  <small style="opacity:.75;">Now Playing</small>
  <b id="abgm_now_title"
     style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:100%;">
    (none)
  </b>
</div>

    <div class="abgm-grid">
      <!-- LEFT: Presets -->
      <section class="abgm-card">
        <div class="abgm-card-h">
          <b>Presets</b>
          <div class="abgm-row">
            <div class="menu_button" id="abgm_preset_add" title="New Preset">
              <i class="fa-solid fa-plus"></i>
            </div>
            <div class="menu_button" id="abgm_preset_del" title="Delete Preset">
              <i class="fa-solid fa-trash"></i>
            </div>
          </div>
        </div>

        <div class="abgm-row" style="gap:8px;">
          <select id="abgm_preset_select" class="abgm-select"></select>
        </div>

<!-- Default select -->
<div class="abgm-row abgm-row-between">
  <!-- Default select (좌측) -->
  <div class="abgm-top-item" style="min-width:160px;">
    <small style="opacity:.85;">Default</small>
    <select id="abgm_default_select" class="abgm-select"></select>
  </div>

  <!-- Rename (우측) -->
  <div class="abgm-top-item" style="min-width:auto;">
    <small style="opacity:.85;">&nbsp;</small>
    <div id="abgm_preset_rename_btn" class="menu_button abgm-iconbtn" title="Rename Preset">
      <i class="fa-solid fa-pen"></i>
    </div>
  </div>
</div>

<!-- Global Volume (preset select 하단) -->
<div class="abgm-top-row1">
  <div class="abgm-volume-block">
    <small style="opacity:.85;">Global Volume</small>
    <div class="abgm-vol-row">
      <input id="abgm_globalVol" type="range" min="0" max="100" value="70" class="abgm-range">
      <small id="abgm_globalVolText" style="opacity:.85; width:38px; text-align:right;">70</small>

      <!-- Lock 버튼 추가 -->
      <div id="abgm_globalVol_lock" class="menu_button abgm-iconbtn" title="Lock Global Volume">
        <i class="fa-solid fa-lock-open"></i>
      </div>
    </div>
  </div>
</div>

<div class="abgm-row abgm-preset-actions" style="gap:10px; margin-top:10px; flex-wrap:wrap; align-items:center;">
  <div class="menu_button" id="abgm_bind_open" title="Bind this preset to character cards">
    <i class="fa-solid fa-link"></i> Bind
  </div>

  <!-- 오른쪽으로 밀기 -->
  <div class="abgm-row" style="gap:10px; margin-left:auto; flex-wrap:wrap; align-items:center;">
    <div class="menu_button" id="abgm_import"><i class="fa-solid fa-file-import"></i> Import</div>
    <div class="menu_button" id="abgm_export"><i class="fa-solid fa-file-export"></i> Export</div>
  </div>

  <input id="abgm_import_file" type="file" accept="application/json" style="display:none;">
</div>
      </section>

<!-- RIGHT: BGM List -->
<section class="abgm-card">
  <div class="abgm-card-h">
    <b>BGM List</b>
    <div class="abgm-row">
      <div class="menu_button" id="abgm_free_open" title="Free Sources">
        <i class="fa-solid fa-wand-magic-sparkles"></i>
      </div>
      <div class="menu_button" id="abgm_bgm_add" title="Add MP3">
        <i class="fa-solid fa-music"></i>
      </div>
      <div class="menu_button" id="abgm_zip_add" title="Add ZIP">
        <i class="fa-solid fa-file-zipper"></i>
      </div>
      <input id="abgm_zip_file" type="file" accept=".zip,application/zip" style="display:none;">
    </div>
  </div>

  <!-- ===== BGM List controls (2 rows + help) ===== -->

  <!-- Row 1: selected count (left) / sort (right) -->
  <div class="abgm-row abgm-bgmbar1" style="margin-top:8px;">
    <small id="abgm_selected_count" style="opacity:.75;">0 selected</small>

    <div class="abgm-inline" style="margin-left:auto; min-width:240px;">
      <small style="opacity:.85;">Sort</small>
      <select id="abgm_sort" class="abgm-select abgm-select-slim">
        <option value="priority_desc">Priority (High → Low)</option>
        <option value="priority_asc">Priority (Low → High)</option>
        <option value="name_asc">Name (A → Z)</option>
        <option value="name_desc">Name (Z → A)</option>
        <option value="added_asc">Added (old → new)</option>
        <option value="added_desc">Added (new → old)</option>
      </select>
    </div>
  </div>

  <!-- Row 2: delete+Vol reset+help (left) / add+expand+collapse+lock (right) -->
<div class="abgm-row abgm-bgmbar2" style="margin-top:8px; align-items:center; gap:10px;">
  <div class="menu_button" id="abgm_delete_selected" title="Delete selected entries">
    <i class="fa-solid fa-trash"></i> Ent
  </div>

  <!-- Vol reset -->
<div class="menu_button" id="abgm_reset_vol_selected" title="Reset volume of selected">
  <i class="fa-solid fa-rotate-left"></i> Vol
</div>

  <!-- 우측 정렬 영역 -->
  <div class="abgm-row" style="margin-left:auto; gap:10px; align-items:center;">
    <!-- 새로고침 버튼 -->
    <div class="menu_button" id="abgm_refresh_list" title="Refresh BGM list">
      <i class="fa-solid fa-arrows-rotate"></i>
    </div>
    <!-- 엔트리 추가 버튼: 책 버튼 원래 자리로 -->
    <div class="menu_button" id="abgm_bgm_add_row" title="Add empty entry">
      <i class="fa-solid fa-plus"></i>
    </div>

    <div class="menu_button" id="abgm_expand_all" title="Expand all rows">
      <i class="fa-solid fa-angles-down"></i>
    </div>
    <div class="menu_button" id="abgm_collapse_all" title="Collapse all rows">
      <i class="fa-solid fa-angles-up"></i>
    </div>
    <div class="menu_button" id="abgm_lock_all_vol" title="Lock all volume sliders">
      <i class="fa-solid fa-lock"></i>
    </div>
  </div>

  <input id="abgm_bgm_file" type="file" accept="audio/*,.mp3,.wav,.ogg,.flac,.m4a,.aac,.wma,.opus,.webm" style="display:none;">
</div>

  <!-- 집 나갔던 파일들 -->
  <div class="abgm-tablewrap">
    <table class="abgm-table">
      <thead>
        <tr>
          <th class="abgm-col-check">
            <input type="checkbox" id="abgm_sel_all" title="Select all">
          </th>
          <th>File</th>
          <th style="width:48px;">Play</th>
          <th style="width:40px;">Type</th>
          <th style="width:48px;">More</th>
        </tr>
      </thead>
      <tbody id="abgm_bgm_tbody"></tbody>
    </table>
  </div>
</section>
    </div>
  </div>
</div>
<!-- /Main Panel -->

<!-- Mode Panel -->
<div class="myaoplay-tab-panel" role="tabpanel" id="myaoplay-panel-mode" aria-labelledby="myaoplay-tab-mode" tabindex="0">
  
  <!-- Mode Sub-tabs -->
  <div class="abgm-mode-subtabs" role="tablist" aria-label="Mode sub-tabs">
    <button type="button" class="abgm-mode-subtab is-active" data-mode-tab="keyword" role="tab" aria-selected="true">🎤 Keyword</button>
    <button type="button" class="abgm-mode-subtab" data-mode-tab="time" role="tab" aria-selected="false">⏰ Time</button>
    <button type="button" class="abgm-mode-subtab" data-mode-tab="sfx" role="tab" aria-selected="false">🔊 SFX</button>
  </div>

  <!-- Keyword Mode Settings -->
  <div class="abgm-mode-subpanel is-active" id="abgm-mode-keyword" data-mode-panel="keyword">
    <div class="abgm-card" style="padding:15px;">
      <b>키워드 모드 세부 설정</b>
      
      <div class="abgm-field" style="margin-top:12px;">
        <small style="opacity:.85;">작동 방식</small>
        <select id="abgm_kw_submode" class="abgm-select" style="margin-top:4px;">
          <option value="matching">Matching (기존 방식)</option>
          <option value="token">Token (AI 토큰 인식)</option>
          <option value="hybrid">Hybrid (토큰 우선, 매칭 보조)</option>
          <option value="recommend">Recommend (추천 모드)</option>
        </select>
      </div>

      <div class="abgm-kw-mode-desc" style="margin-top:10px; padding:10px; border-radius:8px; font-size:12px; line-height:1.4;">
        <div id="abgm_kw_mode_desc_matching">
          <b>Matching:</b> AI 마지막 메시지에서 BGM List에 설정한 키워드를 직접 찾아 매칭합니다. (기존 방식)
        </div>
        <div id="abgm_kw_mode_desc_token" style="display:none;">
          <b>Token:</b> AI가 <code>{{🎤🐱:keyword}}</code> 형식으로 출력한 토큰만 인식합니다. 프롬프트 설정이 필요합니다.
        </div>
        <div id="abgm_kw_mode_desc_hybrid" style="display:none;">
          <b>Hybrid:</b> 토큰을 우선 인식하고, 토큰이 없으면 기존 매칭 방식으로 폴백합니다.
        </div>
        <div id="abgm_kw_mode_desc_recommend" style="display:none;">
          <b>Recommend:</b> AI가 <code>[MP_REC_QUERY: 검색어]</code> 토큰이 인식되면, 해당 검색어로 음악을 추천받습니다. 자동재생은 지원하지 않고, 추천바에서 직접 확인/재생합니다.
        </div>
      </div>

      <!-- Token/Hybrid 전용: 프롬프트 설정 -->
      <div id="abgm_kw_prompt_section" style="display:none; margin-top:15px; border-top:1px solid rgba(255,255,255,.1); padding-top:15px;">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap;">
          <b style="font-size:13px;">📝 프롬프트 프리셋</b>
          <div style="display:flex; gap:6px;">
            <select id="abgm_kw_prompt_preset" class="abgm-select" style="min-width:120px;"></select>
            <div class="menu_button abgm-iconbtn" id="abgm_kw_prompt_add" title="New Preset">
              <i class="fa-solid fa-plus"></i>
            </div>
            <div class="menu_button abgm-iconbtn" id="abgm_kw_prompt_del" title="Delete Preset">
              <i class="fa-solid fa-trash"></i>
            </div>
            <div class="menu_button abgm-iconbtn" id="abgm_kw_prompt_rename" title="Rename Preset">
              <i class="fa-solid fa-pen"></i>
            </div>
          </div>
        </div>
        
        <textarea id="abgm_kw_prompt_content" class="abgm-textarea" rows="10" style="margin-top:10px; width:100%; font-size:12px; line-height:1.4; resize:vertical;" placeholder="프롬프트 내용..."></textarea>
        
        <div style="margin-top:10px; padding:10px; background:rgba(0,0,0,.25); border-radius:8px; font-size:11px; line-height:1.5;">
          <b>💡 매크로 안내</b><br>
          • <code>{{mya_k}}</code>: 현재 프리셋의 모든 키워드로 치환됩니다.<br>
          • <code>{{mya_p}}</code>: SillyTavern 프롬프트에서 이 프롬프트 전체로 치환됩니다.<br>
          <span style="opacity:.7;">(World Info나 System Prompt 등 원하는 곳에 <code>{{mya_p}}</code>를 넣으세요)</span>
        </div>
      </div>

      <!-- Recommend 전용 설정 -->
      <div id="abgm_kw_recommend_section" style="display:none; margin-top:15px; border-top:1px solid rgba(255,255,255,.1); padding-top:15px;">
        <b style="font-size:13px;">🎧 추천 모드 설정 (🚧 준비 중/확정은 X... 현재 스포티파이에서 자체적으로 create app을 막아둔 상태라 구현 지연됨)</b>
  
        <!-- Provider 선택 -->
        <div class="abgm-field" style="margin-top:12px;">
          <small style="opacity:.85;">Provider</small>
          <select id="abgm_rec_provider" class="abgm-select" style="margin-top:4px;">
            <option value="spotify">Spotify</option>
          </select>
        </div>
  
        <!-- Spotify 연결 상태 -->
        <div id="abgm_rec_spotify_section" style="margin-top:12px;">
          <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
            <span id="abgm_rec_spotify_status" style="font-size:12px; opacity:.8;">
              <i class="fa-solid fa-circle-xmark" style="color:#f44;"></i> Not connected
            </span>
            <button id="abgm_rec_spotify_connect" class="menu_button" style="padding:6px 12px; font-size:12px;">
              <i class="fa-brands fa-spotify"></i> Connect
            </button>
            <button id="abgm_rec_spotify_disconnect" class="menu_button" style="padding:6px 12px; font-size:12px; display:none;">
              <i class="fa-solid fa-unlink"></i> Disconnect
            </button>
          </div>
        </div>
  
        <!-- 추천 옵션 -->
        <div style="margin-top:15px;">
          <small style="opacity:.85;">쿨다운 (초)</small>
          <select id="abgm_rec_cooldown" class="abgm-select" style="margin-top:4px;">
            <option value="30">30초</option>
            <option value="60" selected>60초</option>
            <option value="120">120초</option>
          </select>
        </div>
  
        <label class="abgm-check" style="margin-top:10px;">
          <input type="checkbox" id="abgm_rec_stop_on_enter" checked>
          <span>추천 시 현재 재생 정지</span>
        </label>

        <!-- 추천 프롬프트 프리셋 -->
        <div style="margin-top:15px; border-top:1px solid rgba(255,255,255,.1); padding-top:15px;">
         <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap;">
            <b style="font-size:13px;">📝 추천 프롬프트</b>
            <div style="display:flex; gap:6px;">
              <select id="abgm_rec_prompt_preset" class="abgm-select" style="min-width:120px;"></select>
              <div class="menu_button abgm-iconbtn" id="abgm_rec_prompt_add" title="New Preset">
                <i class="fa-solid fa-plus"></i>
              </div>
              <div class="menu_button abgm-iconbtn" id="abgm_rec_prompt_del" title="Delete Preset">
                <i class="fa-solid fa-trash"></i>
              </div>
              <div class="menu_button abgm-iconbtn" id="abgm_rec_prompt_rename" title="Rename Preset">
                <i class="fa-solid fa-pen"></i>
              </div>
            </div>
          </div>
  
          <textarea id="abgm_rec_prompt_content" class="abgm-textarea" rows="12" style="margin-top:10px; width:100%; font-size:12px; line-height:1.4; resize:vertical;" placeholder="추천 프롬프트 내용..."></textarea>
  
          <div style="margin-top:10px; padding:10px; background:rgba(0,0,0,.25); border-radius:8px; font-size:11px; line-height:1.5;">
            <b>💡 매크로 안내</b><br>
            • <code>{{mya_p}}</code>: SillyTavern 프롬프트에서 이 프롬프트 전체로 치환됩니다.<br>
            <span style="opacity:.7;">(World Info나 System Prompt 등 원하는 곳에 넣으세요)</span>
          </div>
        </div>
  
        <!-- 안내 -->
        <div style="margin-top:12px; padding:10px; background:rgba(0,0,0,.25); border-radius:8px; font-size:11px; line-height:1.5;">
          <b>💡 사용 방법</b><br>
          • AI가 <code>[MP_REC_QUERY: 검색어]</code>를 출력하면 자동으로 추천<br>
          • 추천바에서 [Spotify에서 열기], [다른 추천], [닫기] 가능<br>
          • 이 모드에서는 기존 키워드 자동재생이 비활성화됩니다
        </div>
      </div>

      <!-- 기존 키워드 모드 옵션들 -->
      <div id="abgm_kw_common_options" style="margin-top:15px; border-top:1px solid rgba(255,255,255,.1); padding-top:15px;">
        <b style="font-size:13px;">⚙️ 공통 옵션</b>
        
        <label class="abgm-check" style="margin-top:10px;">
          <input type="checkbox" id="abgm_mode_kw_enabled">
          <span>Keyword Mode 활성화</span>
        </label>
        
        <label class="abgm-check" style="margin-top:8px;">
          <input type="checkbox" id="abgm_mode_kw_once">
          <span>Once (한 번만 재생 후 정지)</span>
        </label>
        
        <label class="abgm-check" style="margin-top:8px;">
          <input type="checkbox" id="abgm_mode_use_default">
          <span>Use Default (키워드 없을 시 기본곡 재생)</span>
        </label>
      </div>
    </div>
  </div>

<!-- Time Mode Settings -->
  <div class="abgm-mode-subpanel" id="abgm-mode-time" data-mode-panel="time" style="display:none;">
    <div class="abgm-card" style="padding:15px;">
      <b>⏰ 타임 모드 설정</b>
      <p style="opacity:.7; margin-top:6px; font-size:12px;">
        시간에 따라 자동으로 키워드를 추가합니다. (키워드 모드와 함께 사용)
      </p>

      <!-- Time Mode Enable -->
      <div class="abgm-row" style="margin-top:12px; gap:10px; align-items:center;">
        <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
          <input type="checkbox" id="abgm_time_enabled" />
          <span>Time Mode 활성화</span>
        </label>
      </div>

      <!-- Source: Token / Realtime -->
      <div class="abgm-time-section" id="abgm_time_source_section" style="margin-top:14px;">
        <small style="opacity:.85;">시간 소스</small>
        <div class="abgm-row" style="gap:12px; margin-top:6px;">
          <label style="display:flex; align-items:center; gap:4px; cursor:pointer;">
            <input type="radio" name="abgm_time_source" value="token" id="abgm_time_source_token" />
            <span>🔤 토큰 (AI 지문에서 추출)</span>
          </label>
          <label style="display:flex; align-items:center; gap:4px; cursor:pointer;">
            <input type="radio" name="abgm_time_source" value="realtime" id="abgm_time_source_realtime" />
            <span>🕐 현실 (시스템 시간)</span>
          </label>
        </div>
      </div>

      <!-- Scheme: 4분할 / 2분할 -->
      <div class="abgm-time-section" id="abgm_time_scheme_section" style="margin-top:14px;">
        <small style="opacity:.85;">시간 구간</small>
        <div class="abgm-row" style="gap:12px; margin-top:6px;">
          <label style="display:flex; align-items:center; gap:4px; cursor:pointer;">
            <input type="radio" name="abgm_time_scheme" value="day4" id="abgm_time_scheme_day4" />
            <span>4분할 (아침/낮/저녁/밤)</span>
          </label>
          <label style="display:flex; align-items:center; gap:4px; cursor:pointer;">
            <input type="radio" name="abgm_time_scheme" value="ampm2" id="abgm_time_scheme_ampm2" />
            <span>2분할 (오전/오후)</span>
          </label>
        </div>
      </div>

      <!-- Day4 구간 설정 -->
      <div class="abgm-time-slots" id="abgm_time_day4_slots" style="margin-top:14px;">
        <small style="opacity:.85;">4분할 구간 설정</small>
        <div class="abgm-time-slot-list" style="margin-top:8px; display:flex; flex-direction:column; gap:8px;">
          <div class="abgm-time-slot" data-slot-id="morning">
            <span class="abgm-time-slot-label">🌅 아침</span>
            <input type="text" class="abgm-time-kw" data-field="keywords" placeholder="아침, Morning" />
            <input type="time" class="abgm-time-start" data-field="start" />
            <span>~</span>
            <input type="time" class="abgm-time-end" data-field="end" />
          </div>
          <div class="abgm-time-slot" data-slot-id="day">
            <span class="abgm-time-slot-label">☀️ 낮</span>
            <input type="text" class="abgm-time-kw" data-field="keywords" placeholder="낮, Daytime" />
            <input type="time" class="abgm-time-start" data-field="start" />
            <span>~</span>
            <input type="time" class="abgm-time-end" data-field="end" />
          </div>
          <div class="abgm-time-slot" data-slot-id="evening">
            <span class="abgm-time-slot-label">🌆 저녁</span>
            <input type="text" class="abgm-time-kw" data-field="keywords" placeholder="저녁, Evening" />
            <input type="time" class="abgm-time-start" data-field="start" />
            <span>~</span>
            <input type="time" class="abgm-time-end" data-field="end" />
          </div>
          <div class="abgm-time-slot" data-slot-id="night">
            <span class="abgm-time-slot-label">🌙 밤</span>
            <input type="text" class="abgm-time-kw" data-field="keywords" placeholder="밤, Night" />
            <input type="time" class="abgm-time-start" data-field="start" />
            <span>~</span>
            <input type="time" class="abgm-time-end" data-field="end" />
          </div>
        </div>
      </div>

      <!-- AMPM2 구간 설정 -->
      <div class="abgm-time-slots" id="abgm_time_ampm2_slots" style="margin-top:14px; display:none;">
        <small style="opacity:.85;">2분할 구간 설정</small>
        <div class="abgm-time-slot-list" style="margin-top:8px; display:flex; flex-direction:column; gap:8px;">
          <div class="abgm-time-slot" data-slot-id="am">
            <span class="abgm-time-slot-label">🌤️ 오전</span>
            <input type="text" class="abgm-time-kw" data-field="keywords" placeholder="오전, AM" />
            <input type="time" class="abgm-time-start" data-field="start" />
            <span>~</span>
            <input type="time" class="abgm-time-end" data-field="end" />
          </div>
          <div class="abgm-time-slot" data-slot-id="pm">
            <span class="abgm-time-slot-label">🌙 오후</span>
            <input type="text" class="abgm-time-kw" data-field="keywords" placeholder="오후, PM" />
            <input type="time" class="abgm-time-start" data-field="start" />
            <span>~</span>
            <input type="time" class="abgm-time-end" data-field="end" />
          </div>
        </div>
      </div>

      <!-- 도움말 -->
      <div class="abgm-minihelp" style="margin-top:14px; padding:10px; background:rgba(0,0,0,.2); border-radius:8px; font-size:12px;">
        <b>💡 사용법</b>
        <ul style="margin:6px 0 0 16px; padding:0; line-height:1.5;">
          <li><b>토큰 모드</b>: AI 지문에서 "13:00", "오후 3시", "9pm" 같은 형식의 시간 표현을 인식</li>
          <li><b>현실</b>: 현재 시스템 시간을 사용</li>
          <li>타임 모드 설정에서 지정한 시간대가 지문에 등장 시 확장이 키워드로 인식함</li>
          <li>자정을 넘기는 구간도 지원 (예: 21:00~04:59)</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- SFX Mode Settings -->
  <div class="abgm-mode-subpanel" id="abgm-mode-sfx" data-mode-panel="sfx" style="display:none;">
    <div class="abgm-card" style="padding:15px;">
      <b>🔊 SFX 모드 설정</b>
      <p style="opacity:.7; margin-top:6px; font-size:12px;">
        효과음(SFX) 타입 엔트리의 재생 방식을 설정합니다.
      </p>

      <!-- SFX 특징 안내 -->
      <div style="margin-top:12px; padding:10px; background:rgba(0,0,0,.2); border-radius:8px; font-size:12px; line-height:1.5;">
        <b>💡 SFX 타입 특징</b>
        <ul style="margin:6px 0 0 16px; padding:0;">
          <li>키워드 매칭 시 <b>1회만</b> 재생 (같은 턴 반복 X)</li>
          <li>여러 SFX 매칭 시 <b>1개만</b> 선택 재생</li>
          <li>BGM과 <b>별도 채널</b>로 재생</li>
        </ul>
      </div>

      <!-- Overlay 옵션 -->
      <div style="margin-top:15px; border-top:1px solid rgba(255,255,255,.1); padding-top:15px;">
        <b style="font-size:13px;">⚙️ 재생 옵션</b>
        
        <label class="abgm-check" style="margin-top:10px;">
          <input type="checkbox" id="abgm_sfx_overlay">
          <span>Overlay (BGM 위에 겹쳐 재생)</span>
        </label>
        <p style="opacity:.6; font-size:11px; margin:4px 0 0 24px;">
          OFF 시: SFX 재생 동안 BGM 일시정지 → SFX 끝나면 BGM 복귀
        </p>
        
        <label class="abgm-check" style="margin-top:12px;">
          <input type="checkbox" id="abgm_sfx_skip_other">
          <span>키워드 모드 외에서 SFX 건너뛰기</span>
        </label>
        <p style="opacity:.6; font-size:11px; margin:4px 0 0 24px;">
          Loop List, Random 등 다른 모드에서 SFX 타입 곡 스킵
        </p>
      </div>

      <!-- 사용법 -->
      <div class="abgm-minihelp" style="margin-top:15px; padding:10px; background:rgba(0,0,0,.2); border-radius:8px; font-size:12px;">
        <b>📝 사용법</b>
        <ul style="margin:6px 0 0 16px; padding:0; line-height:1.5;">
          <li>BGM List에서 엔트리의 <b>[B]</b> 버튼을 눌러 <b>[S]</b>로 변경</li>
          <li>SFX 타입은 키워드 모드에서 효과음처럼 동작</li>
          <li>일반 BGM과 동일하게 키워드, 우선도 설정 가능</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Sources Panel -->
<div class="myaoplay-tab-panel" role="tabpanel" id="myaoplay-panel-sources" aria-labelledby="myaoplay-tab-sources" tabindex="0">
  <!-- Free Sources 내용 시작 -->
  <div class="abgm-fs-inner">
    <!-- tabs: Free / My -->
    <div class="abgm-fs-tabs" role="tablist" aria-label="Sources tabs">
      <button type="button" class="abgm-fs-tab is-active" data-tab="free" role="tab" aria-selected="true">Free</button>
      <button type="button" class="abgm-fs-tab" data-tab="my" role="tab" aria-selected="false">My(🚧 준비 중)</button>
    </div>
    <!-- search row -->
    <div class="abgm-fs-searchrow">
      <input id="abgm_fs_search" type="text" placeholder="Search..." class="abgm-fs-search" />
      <button id="abgm_fs_clear" type="button" class="menu_button abgm-fs-clear">Clear</button>
      <select id="abgm_fs_sort" class="abgm-fs-sort" title="Sort order">
        <option value="date-newest">Date (Newest)</option>
        <option value="date-oldest">Date (Oldest)</option>
        <option value="name-asc">Name (A→Z)</option>
        <option value="name-desc">Name (Z→A)</option>
      </select>
    </div>
    <!-- preview volume row -->
    <div class="abgm-fs-prevrow" aria-label="Preview volume">
      <small class="abgm-fs-prevlabel">Preview</small>
      <input id="abgm_fs_prevvol" type="range" min="0" max="100" step="1" class="abgm-fs-prevvol" value="60" />
      <span id="abgm_fs_prevvol_val" class="abgm-fs-prevval">60%</span>
      <button id="abgm_fs_prevvol_lock" type="button" class="menu_button abgm-iconbtn abgm-fs-prevlock" title="Lock slider">
        <i class="fa-solid fa-lock-open"></i>
      </button>
      <button id="abgm_fs_emit_json" type="button" class="menu_button abgm-iconbtn abgm-fs-jsonbtn" title="프리소스 JSON 생성(확장 제작자용)">✎</button>
    </div>
    <!-- category bar -->
    <div id="abgm_fs_catbar" class="abgm-fs-catbar">
      <button type="button" class="menu_button abgm-fs-cat is-active" data-cat="all">ETC</button>
      <button type="button" class="menu_button abgm-fs-cat" data-cat="tempo">Tempo</button>
      <button type="button" class="menu_button abgm-fs-cat" data-cat="genre">Genre</button>
      <button type="button" class="menu_button abgm-fs-cat" data-cat="inst">Inst</button>
      <button type="button" class="menu_button abgm-fs-cat" data-cat="mood">Mood</button>
      <button type="button" class="menu_button abgm-fs-cat" data-cat="lyric">Lyric</button>
    </div>
    <!-- dropdown tag picker -->
    <div id="abgm_fs_tag_picker" class="abgm-fs-picker" style="display:none;"></div>
    <!-- list -->
    <div id="abgm_fs_list" class="abgm-fs-list"></div>
  </div>
</div>

<!-- Theme Panel -->
<div class="myaoplay-tab-panel" role="tabpanel" id="myaoplay-panel-theme" aria-labelledby="myaoplay-tab-theme" tabindex="0">
  <div class="abgm-card" style="padding:15px;">
    <b>테마 설정</b>
    <p style="margin-top:10px; margin-bottom:12px;">테마를 선택하세요.</p>
    <div class="abgm-theme-btns" style="display:flex; gap:10px; flex-wrap:wrap;">
      <button type="button" class="menu_button abgm-theme-btn" data-theme="light">
        ☀️ 라이트
      </button>
      <button type="button" class="menu_button abgm-theme-btn" data-theme="dark">
        🌙 다크
      </button>
    </div>
  </div>
</div>

<!-- About Panel -->
<div class="myaoplay-tab-panel" role="tabpanel" id="myaoplay-panel-about" aria-labelledby="myaoplay-tab-about" tabindex="0">
  <div class="abgm-card" style="padding:15px;">
    <b>MyaoPlay 정보</b>

    <details class="abgm-details" style="margin-top:10px;">
      <summary class="abgm-details-summary">🧾 변경사항 (Changelog)</summary>
      <div class="abgm-details-body">
        <div>2026~</div>
        <div>01-14: v1.0.0 배포</div>
        <div>01-15: 테마를 따라가지 못하던 요소 일부(메뉴) &amp; Bind 창의 UI 및 캐릭터 이름 정렬순 개선</div>
        <div>01-17: 깡싸 게시글 수정 / 소스 &gt; 쓸모없어진 No lyric 태그 제거 / 확장 공유 관련 라이센스 강화 / 소스 &gt; 정렬순 &amp; 가사 및 라이센스 저장 시스템 추가 &amp; options 바텀시트 내 복사&amp;정보 분리</div>
        <div>01-18: SillyTavern 요술봉 메뉴에 버튼 추가 / BGM List 새로고침 버튼 추가</div>
        <div>01-19: Default 곡 없는 프리셋 불러오기 시 None 유지하도록 정상 개선 / 설정 창 타이틀 제거 & 해당 자리에 활성화/비활성화 버튼 추가</div>
        <div>01-20: Change Mp3 버튼을 Change Source 버튼으로 변경</div>
        <div>01-21: 단일 파일 혹은 zip을 먹였을 때 다른 프리셋으로 튕겨나가는 치명적인 버그 개선 / BPM 태그 분류 방식 개선</div>
        <div>01-23: 확장자 호환 개선</div>
      </div>
    </details>

    <details class="abgm-details" style="margin-top:10px;">
  <summary class="abgm-details-summary">📜 License</summary>

  <div class="abgm-details-body">
    <div>✔️ 본 확장은 비상업적 용도에 한하여 깡싸(https://kkangtong.xyz/) 내에서만 재배포를 허용하며, 그 외 모든 외부 사이트·플랫폼으로의 재배포를 금지함</div>
    <div>✔️ 해당 확장 공유 시 출처 표기 필수 (깃허브/깡싸 주소 중에 편한 곳)</div>
    <div>✔️ 확장 자체의 코드 일부를 가져다 쓰거나 일부 수정하여 배포하는 행위는 일체 금지</div>
    <div>✔️ 프리소스 오디오는 제작자가 직접 제작한 것으로, 비상업적 용도에 한해 깡싸 내 자유 사용·편집·공유 허용</div>
    <div>✔️ 확장을 통해 생성된 프리셋 및 사용자 데이터는 자유 사용 가능 (단, 아래 사항 확인)</div>

    <hr class="abgm-hr">

    <details class="abgm-details">
      <summary class="abgm-details-summary">⚠️ 외부 오디오 소스를 삽입한 프리셋 공유 시 주의사항</summary>

      <div class="abgm-details-body">
        <div>✔️ mp3 파일을 직접 번들링(zip)하지 말고 URL 형태로 삽입 권장</div>
        <div>✔️ 삽입되는 모든 오디오·이미지는 합법적인 라이센스를 가진 것만 사용해야 하며 책임은 사용자에게 있음</div>
        <div>✔️ 프리셋 공유 시 오디오의 출처·크레딧·라이센스 정보를 동봉 권장</div>
        <div>✔️ ND(No Derivatives) 라이센스 오디오는 키워드 트리거 특성상 파생작으로 간주될 수 있으므로 사용 주의</div>
      </div>
    </details>

    <hr class="abgm-hr">

    <div>✔️ 본 확장은 AS-IS로 제공되며 어떠한 보증도 하지 않음</div>
    <div>✔️ 사용으로 인한 모든 손해 및 저작권 문제에 대해 제작자는 책임을 지지 않음</div>
    <div>✔️ This project is licensed under CC BY-NC-ND 4.0.</div>
    <div>✔️ Third-party library: JSZip (MIT License)</div>
  </div>
</details>

  </div>
</div>
  
  <!-- Bind Overlay (covers modal) -->
  <div id="abgm_bind_overlay" class="abgm-bind-overlay">
    <div class="abgm-bind-box">
      <div class="abgm-bind-header">
        <b id="abgm_bind_title">Bind Preset</b>
        <div class="menu_button" id="abgm_bind_close" title="Close">
          <i class="fa-solid fa-xmark fa-lg"></i>
        </div>
      </div>
      <div class="abgm-bind-body">
        <small id="abgm_bind_sub" class="abgm-bind-sub">Select a character</small>
        <div id="abgm_bind_list" class="abgm-bind-list"></div>
      </div>
    </div>
  </div>
  </div>
</div>
